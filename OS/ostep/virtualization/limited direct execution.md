# Limited Direct Execution

为了虚拟化 CPU，OS 需要在许多看起来同时运行的进程间共享物理 CPU 资源，这就引入了两个问题：

* 性能：如何在不给系统增加过多开销的情况下实现虚拟化
* 控制：如何在保持对 CPU 控制的同时有效地运行进程

因此，在保持对 CPU 控制的同时获得高性能是构建 OS 的关键点之一

## Direct Execution

Direct Execution 指**直接在 CPU 上运行程序**，这样能够使得程序运行的尽可能块

|OS|program|
|--|---|
|在进程列表中创建入口||
|为程序分配内存||
|将程序加载至内存||
|设置栈||
|执行对程序入口 (main()) 的调用||
||运行 main()|
||执行 return|
|释放进程内存||
|从进程列表中移除||

## Direct Execution 的缺陷（一）

如果程序直接运行在 CPU 上，就可以无限制地操作硬件与 OS，如：访问磁盘进行 I/O 请求，这显然是不可行的。由此引入「用户态」&「内核态」的概念：

* 首先需要明确的是：**这属于 CPU 的硬件支持**
* 在用户态下程序无法执行受限的 CPU 指令，只能通过执行「系统调用」来执行
* 为了执行系统调用，需要先执行 trap 指令来使 OS 从用户态「陷入」内核态；进入内核态后 OS 可以执行受限指令，完成进程的任务后 OS 执行 return-from-trap 返回用户态
* 内核需要在引导时建立 trap table 以保证用户程序执行 trap 指令后能跳转到对应地址进行 trap 操作
