# 文件系统概览
![[image/linux 文件系统.png]]

* 虚拟文件系统：屏蔽不同文件系统的差异，对用户提供统一接口
* 文件系统：将 OS 按数据块（Linux 下为 4KB）读写磁盘数据和用户按字节读写文件数据对应进行映射

# 文件 I/O

## 缓冲与非缓冲

文件操作的库可以实现数据的缓存，根据**是否利用库的缓存功能**：

* 缓冲 I/O：通过文件库的缓存加速文件读写，而文件库再通过系统调用访问文件
* 非缓冲 I/O：直接通过系统调用访问文件

作用：减少系统调用（上下文切换）

## 直接与非直接

Linux 为了减少磁盘 I/O 次数，在内核中实现了数据缓冲区，根据**是否利用 OS 的缓存功能**：

* 直接 I/O：直接通过文件系统访问磁盘，不会发生内核缓存与用户程序之间的数据复制
* 非直接 I/O：读时数据从内核缓存复制到用户程序，写时数据从用户程序复制到内核缓存，由内核决定数据写入磁盘的时机

作用：减少一次数据从内核缓冲到用户程序的复制，但像 MySQL 这种程序，则使用直接 I/O，因为自身实现了命中率更高的缓存机制

## 阻塞与非阻塞

阻塞 I/O：阻塞的是**等带内核缓存准备数据**和**将内核缓存数据复制到用户程序**这两个阶段
![[io/image/阻塞 IO.jpg]]

非阻塞 I/O：相比阻塞 I/O，只在**将内核缓存数据复制到用户程序**阶段发生了阻塞，没有被阻塞在等待内核准备数据的阶段，但代替这种等待的是需要用户程序轮询内核查看数据是否已 ready
![[io/image/非阻塞 IO.jpg]]

非阻塞 I/O - 多路复用：

## 同步与异步

上述的阻塞与非阻塞 I/O 其他都是同步 I/O，因为在将数据从内核缓存复制到用户程序的这个过程中，用户进程都是需要等待的，真正的异步调用，两个阶段是都不需要等待的
![[io/image/异步 IO.jpg]]

# Page Cache

page cache 就是缓冲 I/O 使用的数据缓冲区，本质上是 Linux 内核管理的一块内存区域
![[image/linux 文件系统-page cache.png]]

## 数据一致性

* Write Through：向用户层提供接口，应用程序可以主动调用来保证磁盘数据和缓存一致
* Write Back：内核线程周期性的将脏页刷新回磁盘

## 优缺点

优点：
* 加快数据访问，访问内存比磁盘快很多
* 减少 I/O 次数，可一次装载多个 page，而程序往往又符合局部性原理，可提高系统磁盘 I/O 吞吐量
缺点：
* 占用额外的物理内存空间，极端情况下会导致频繁的 swap 操作
* 对应用层没有提供很好的 API，导致一些应用在内存中实现自己的 page cache，如 MySQL
* 某些场景下比直接 I/O 多一次磁盘交互