# Mechanism : Address Translation

## 简介

* 将（基于硬件的）地址转换看作是 limited direct execution 的一种补充：硬件将对内存的每一次访问（取指令、取值、存值）都进行处理，将指令提供的虚拟内存地址转换成数据实际存储的物理地址
* 硬件只提供了高效地进行内存地址虚拟化的机制，但无法独自完成，OS 必须在关键阶段介入，设置好硬件，还需要管理内存，追踪使用中内存和空闲内存
* 实际上许多进程同时共享着内存，就像通过进程切换来共享 CPU

## 假设

* 进程的地址空间在物理内存中是连续的
* 地址空间并不是足够大的，要小于物理地址空间
* 每个进程使用的地址空间的大小是相同的

## example

|                           进程视角                            | OS 视角                                                       |
|:-------------------------------------------------------------:| ------------------------------------------------------------- |
| ![[img/address translation/Snipaste_2022-06-12_11-29-52.png]] | ![[img/address translation/Snipaste_2022-06-12_11-30-13.png]] |

## （基于硬件的）地址转换

机制：
* 需要两个 CPU 寄存器支持：base register & bounds register
* 当程序执行时，物理地址的值被记录在 base register 中，程序运行过程中产生的虚拟内存地址，都需要加上 base register 中的值，来转换成实际的物理地址（目标：高效）
* bounds register 中存放着 OS 分配给进程的虚拟空间地址的边界值，进程产生的虚拟内存地址后进程 check：不允许超过这个值，也不允许为负数

其他：
* 这个过程发生在程序运行时并且 OS 可以移动整个地址空间，所以又称为动态重定位
* base register & bounds register 统称为 memory management unit
* bounds register 也可以存放转换后的该进程的物理地址边界，不同的是在转换为物理地址后才去 check，逻辑上是等价的

## 硬件支持

|                硬件需求                | 注意                                        |
|:--------------------------------------:| ------------------------------------------- |
|                特权模式                | 阻止用户态进程执行越权操作                  |
|         base & bounds register         | 支持地址转换 & 地址越界检查                 |
|        翻译、检查虚拟地址的能力        | 由电路完成                                  |
| 更新 base & bounds register 的特权指令 | OS 必须能够在用户进程运行前设置这些值       |
|        注册异常处理器的特权指令        | OS 必须能够告知硬件当异常发生时执行哪些代码 |
|             触发异常的能力             | 当进程尝试访问特权指令或内存地址越界时      |

## OS 支持

| OS 需求                | 注意                                                                |
| ---------------------- | ------------------------------------------------------------------- |
| 内存管理               | 为新进程分配内存、释放被终止进程的内存，通常通过 free list 管理内存 |
| base & bounds register | 必须在上下文切换时正确设置它们的值                                  |
| 异常处理               | 提供异常发生时需要执行的代码，比如中止判定是有敌意的进程            |
 
## limited direct execution with dynamic relocation

| OS boot（内核态）    | 硬件                                                                                         | 进程 |
| -------------------- | -------------------------------------------------------------------------------------------- | ---- |
| 初始化 trap table    |                                                                                              |      |
|                      | 记住各种处理器的地址：系统调用处理器、时钟中断处理器、非法内存访问处理器、非法指令执行处理器 |      |
| 开启时钟中断         |                                                                                              |      |
|                      | 开启时钟中断处理器，每 Xms 发生一次中断                                                      |      |
| 初始化 process table |                                                                                              |      |
| 初始化 free list     |                                                                                              |      |

| OS run（内核态）                                                                       | 硬件                         | 进程（用户态）  |
| -------------------------------------------------------------------------------------- | ---------------------------- | --------------- |
| 开始执行进程 A：                                                                       |                              |                 |
| 在 process table 中分配入口                                                            |                              |                 |
| 分配内存                                                                               |                              |                 |
| 设置 base & bounds register                                                            |                              |                 |
| return-from-trap to A                                                                  |                              |                 |
|                                                                                        | 恢复 A 使用的用户寄存器的值  |                 |
|                                                                                        | 切换为用户态                 |                 |
|                                                                                        | 跳转至 PC 指向               |                 |
|                                                                                        |                              | A 运行          |
|                                                                                        |                              | 取指令          |
|                                                                                        | 转换虚拟地址                 |                 |
|                                                                                        | 执行取指令                   |                 |
|                                                                                        |                              | 执行指令        |
|                                                                                        | 如果涉及了 load / store 操作 |                 |
|                                                                                        | 转换虚拟地址                 |                 |
|                                                                                        | 执行 load / store            |                 |
|                                                                                        |                              | A 运行          |
|                                                                                        | 发生中断                     |                 |
|                                                                                        | 切换为内核态                 |                 |
|                                                                                        | 跳转至时钟中断处理器处       |                 |
| 执行时钟中断处理                                                                       |                              |                 |
| 调度器决定：停止 A，运行 B                                                             |                              |                 |
| 执行 switch()                                                                          |                              |                 |
| 保存 A 使用的内核寄存器（包括 base & bounds register）数据到 A 的 process-structure 中 |                              |                 |
| 从 B 的 process-structure 中恢复 B 的使用的内核寄存器数据                              |                              |                 |
| return-from-trap to B                                                                  |                              |                 |
|                                                                                        | 恢复 B 使用的用户寄存器的值  |                 |
|                                                                                        | 切换为用户态                 |                 |
|                                                                                        | 跳转至 PC 指向               |                 |
|                                                                                        |                              | B 运行          |
|                                                                                        |                              | 执行非法的 load |
|                                                                                        | load 指令越界                |                 |
|                                                                                        | 切换为内核态                 |                 |
|                                                                                        | 跳转至 trap 处理器处         |                 |
| 执行 trap 处理                                                                         |                              |                 |
| 杀死进程 B                                                                             |                              |                 |
| 释放 B 的内存                                                                          |                              |                 |
| 从 process table 中清空 B 的进程入口                                                   |                              |                 |